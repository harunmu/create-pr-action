name: Test action

on: workflow_dispatch

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Setup
              run: date >> foo.md

            - name: Exercise
              id: exercise
              uses: ./
              with:
                message: Test
            
            - name: Verify
              run: |
                set -x
                test "$(gh pr view "${BRANCH}" --json title -jq.title)" = "Test"
              env:
                BRANCH: ${{ steps.exercise.outputs.branch }}

            - name: Teardown
              if: ${{ always() }}
              run: |
                gh pr close "${BRANCH}" || true
                git  push origin "${BRANCH}" --delete || true
              env:
                BRANCH: ${{ steps.exercise.outputs.branch }}
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}